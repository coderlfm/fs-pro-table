"use strict";var _interopRequireWildcard=require("@babel/runtime/helpers/interopRequireWildcard"),_interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0,require("antd/lib/table/style/css");var _table=_interopRequireDefault(require("antd/lib/table")),_defineProperty2=_interopRequireDefault(require("@babel/runtime/helpers/defineProperty")),_regenerator=_interopRequireDefault(require("@babel/runtime/regenerator"));require("antd/lib/message/style/css");var _message2=_interopRequireDefault(require("antd/lib/message")),_slicedToArray2=_interopRequireDefault(require("@babel/runtime/helpers/slicedToArray")),_react=_interopRequireWildcard(require("react")),_proForm=_interopRequireDefault(require("../pro-form")),_ProTableHeader=_interopRequireDefault(require("./Pro-table-header"));require("./index.css");var __awaiter=function(e,i,o,l){return new(o=o||Promise)(function(a,t){function r(e){try{s(l.next(e))}catch(e){t(e)}}function n(e){try{s(l.throw(e))}catch(e){t(e)}}function s(e){var t;e.done?a(e.value):((t=e.value)instanceof o?t:new o(function(e){e(t)})).then(r,n)}s((l=l.apply(e,i||[])).next())})},tableDataDefault={list:[],page:1,page_size:10};function onChange(e,t,a,r){console.log("params",e,t,a,r)}var _default=(0,_react.memo)(function(a){var e=this,i=a.tabs,t=a.title,r=a.tableTools,s=a.preSubmit,n=a.requestData,o=a.getAllParams,l=a.request,c=(0,_react.useRef)(null),u=((0,_react.useRef)(!1),(0,_react.useState)(tableDataDefault)),d=(0,_slicedToArray2.default)(u,2),f=d[0],b=d[1],g=(0,_react.useState)([]),u=(0,_slicedToArray2.default)(g,2),d=u[0],_=u[1],g=(0,_react.useState)([]),u=(0,_slicedToArray2.default)(g,2),g=u[0],p=u[1],u=(0,_react.useState)(Object.assign(Object.assign({},{page:1,page_size:10,search:{},sort:{}}),n)),u=(0,_slicedToArray2.default)(u,2),v=u[0],y=u[1],u=(0,_react.useState)(!0),u=(0,_slicedToArray2.default)(u,2),h=u[0],m=u[1];(0,_react.useEffect)(function(){m(!0),T(),"function"==typeof o&&(console.log("reqData变化了"),o(v))},[v,a.reset]),(0,_react.useEffect)(function(){i&&Object.keys(i).length&&(c.current=getTabsInitReq(i),1===Object.keys(i).length?Object.keys(c.current).length&&y(Object.assign(Object.assign({},v),{search:Object.assign(Object.assign({},v.search),c.current)})):2===Object.keys(c.current).length&&y(Object.assign(Object.assign({},v),{search:Object.assign(Object.assign({},v.search),c.current)})))},[i]);var T=function(){return __awaiter(e,void 0,void 0,_regenerator.default.mark(function e(){var t;return _regenerator.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return h||m(!0),e.next=3,l({url:a.url,method:"post",data:Object.assign(Object.assign({},v),n)});case 3:0===(t=e.sent).code?b(Object.assign(Object.assign({},f),t.data)):"0"===t.code?b(Object.assign(Object.assign({},f),t.result)):_message2.default.warning(t.msg||"请求超时"),m(!1);case 6:case"end":return e.stop()}},e)}))},u=function(e,t){console.log(e,t),y(Object.assign(Object.assign({},v),{page:e,page_size:t}))},u={onChange:u,onShowSizeChange:u,total:f.total,pageSize:f.page_size,current:f.page,showSizeChanger:!0,showTotal:function(e){return"共".concat(e,"条")}},g={type:"checkbox",selectedRowKeys:g,hideOnSinglePage:!0,onChange:function(e,t){p(e),_(t)}};return _react.default.createElement("div",{className:"pro-table-wrap"},_react.default.createElement(_ProTableHeader.default,{title:t,tabs:i,firstTabsChange:function(e,t){var a,r,n=v.search[null===(a=i.secondTabs)||void 0===a?void 0:a.key]?v.search[null===(n=i.secondTabs)||void 0===n?void 0:n.key]:null===(r=null===(s=i.secondTabs)||void 0===s?void 0:s.data.find(function(e){return e.key===i.secondTabs.defaultKey}))||void 0===r?void 0:r.key,s=Object.assign(Object.assign({},v),{search:(s={},(0,_defineProperty2.default)(s,null===(r=i.secondTabs)||void 0===r?void 0:r.key,n),(0,_defineProperty2.default)(s,e,t),s)});"function"!=typeof i.firstTabs.onChange?y(s):(t=i.firstTabs.onChange(e,t,s),y(t?Object.assign({},t):s))},secondTabsChange:function(e,t){var a=v.search[i.firstTabs.key]||(null===(r=i.firstTabs.data.find(function(e){return e.key===i.firstTabs.defaultKey}))||void 0===r?void 0:r.key),r=Object.assign(Object.assign({},v),{search:(r={},(0,_defineProperty2.default)(r,i.firstTabs.key,a),(0,_defineProperty2.default)(r,e,t),r)});"function"!=typeof i.secondTabs.onChange?y(r):(t=i.secondTabs.onChange(e,t,r),y(t?Object.assign({},t):r))}}),a.formProps?_react.default.createElement(_proForm.default,{formProps:a.formProps,submit:function(n){return __awaiter(e,void 0,void 0,_regenerator.default.mark(function e(){var t,a,r;return _regenerator.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(t=Object.assign(Object.assign({},v.search),n),Object.keys(t).forEach(function(e){t[e]||delete t[e]}),a=Object.assign(Object.assign({},v),{search:t,page:1}),"function"==typeof s)return e.next=6,s(a);e.next=8;break;case 6:r=e.sent,a=r||a;case 8:y(a);case 9:case"end":return e.stop()}},e)}))},circle:!i||!i.secondTabs}):null,_react.default.createElement("div",{className:"pro-table-body-wrap"},r&&renderTools(r,d),_react.default.createElement(_table.default,{columns:a.columns,dataSource:f.list,rowKey:a.rowKey,rowSelection:a.row&&g,size:"middle",onChange:onChange,loading:h,pagination:u})))});exports.default=_default;var renderTools=function(e,a){return _react.default.createElement("div",{className:"pro-table-tools"},_react.default.createElement("div",{className:"pro-table-tools-title"},e.title?_react.default.createElement(_react.default.Fragment,null,_react.default.createElement("span",null),_react.default.createElement("span",null,e.title)):null),_react.default.createElement("div",{className:"pro-table-tools-actions-wrap"},e.actions.map(function(e,t){return _react.default.createElement("div",{key:t},null==e?void 0:e.render(a))})))},getTabsInitReq=function(t){var e,a,r,n={},n=null!==(null===(e=t.firstTabs)||void 0===e?void 0:e.defaultKey)?(0,_defineProperty2.default)({},null===(e=t.firstTabs)||void 0===e?void 0:e.key,null===(e=null===(e=t.firstTabs)||void 0===e?void 0:e.data.find(function(e){return e.key===t.firstTabs.defaultKey}))||void 0===e?void 0:e.key):(0,_defineProperty2.default)({},null===(a=t.firstTabs)||void 0===a?void 0:a.key,null===(a=null===(a=t.firstTabs)||void 0===a?void 0:a.data[0])||void 0===a?void 0:a.key);return n=null!==(null===(a=t.secondTabs)||void 0===a?void 0:a.defaultKey)?Object.assign(Object.assign({},n),(0,_defineProperty2.default)({},null===(r=t.secondTabs)||void 0===r?void 0:r.key,null===(r=null===(r=t.secondTabs)||void 0===r?void 0:r.data.find(function(e){return e.key===t.secondTabs.defaultKey}))||void 0===r?void 0:r.key)):Object.assign(Object.assign({},n),(0,_defineProperty2.default)({},null===(r=t.secondTabs)||void 0===r?void 0:r.key,null===(r=null===(r=t.secondTabs)||void 0===r?void 0:r.data[0])||void 0===r?void 0:r.key)),Object.keys(n).forEach(function(e){n[e]||delete n[e]}),n};